<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NBA Analysis</title>
    <!-- LeanCloud SDK-->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3.11.0/dist/av-min.js"></script>
    <!-- LeanCloud Init-->
    <script src="js/initLeanCloud.js"></script>
    <script src="js/playerInfo.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/4.1.0/echarts.js"></script>
    <!-- Bootstrap-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
    <!-- Bulma Version 0.7.2-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css" />
    <link rel="stylesheet" type="text/css" href="css/admin.css">
    <script type="text/javascript">
        var shotlist = [];
        var paramsJson = {
            player_name: 'Stephen Curry',
            distance: -1,
            time: -1,
        };
        AV.Cloud.run('player_xy', paramsJson).then(function(data) {
            console.log(data);
            for (i in data) {
                var element = [parseFloat(data[i]['original_x']), parseFloat(data[i]['original_y']), 
                                data[i]['type'], data[i]['remaining_time']];
                shotlist.push(element);
            }
            var shotpointsChat = echarts.init(document.getElementById('main'));

            var option_shotpoints = {
                xAxis: {
                    scale: true
                },
                yAxis: {
                    scale: true
                },
                tooltip: {
                    formatter: function (params) {
                        return "<li>" + 'Type: ' + params.value[2] + 
                               "<li>" + 'Remaining time: ' + params.value[3];
                    }
                },
                series: [{
                    type: 'scatter',
                    data: shotlist,
                }]
            };
            // 使用刚指定的配置项和数据显示图表。
            shotpointsChat.setOption(option_shotpoints);


            // 投篮方式表
            var typeChart = echarts.init(document.getElementById('type'));
            var chosen_type = [false, false, false, false, false, false];
            var color_type = ["#4ABACE","#4ABACE","#4ABACE","#4ABACE","#4ABACE","#4ABACE"];
            var x_type_data = ["Jump Shot","Running Jump Shot","Floating Jump Shot","Layup","Running Layup","unknown"];
            var type_list = [[], [], [], [], [], []];
            var type_list2 = [[], [], [], [], [], []];
            for (i in shotlist) {
                if (shotlist[i][2] == "Jump Shot")
                    type_list[0].push(shotlist[i]);
                if (shotlist[i][2] == "Running Jump Shot")
                    type_list[1].push(shotlist[i]);
                if (shotlist[i][2] == "Floating Jump Shot")
                    type_list[2].push(shotlist[i]);
                if (shotlist[i][2] == "Layup")
                    type_list[3].push(shotlist[i]);
                if (shotlist[i][2] == "Running Layup")
                    type_list[4].push(shotlist[i]);
                if (shotlist[i][2] == "unknown")
                    type_list[5].push(shotlist[i]);
            }
            var option_type = {
                title: {
                    text: 'Shot Type'
                },
                tooltip: {},
                // legend: {
                //     data:['销量']
                // },
                grid: {  
                    left: '10%',  
                    bottom:'35%'  
                }, 
                xAxis: {
                    axisLabel: {  
                        interval:0,  
                        rotate:40  
                    }, 
                    data: x_type_data,
                },
                yAxis: {
                },
                series: [{
                            name: 'types',
                            type: 'bar',
                            stack: '1',
                            data: [type_list[0].length, type_list[1].length, type_list[2].length,
                                type_list[3].length, type_list[4].length, type_list[5].length],
                            itemStyle: {
                                color: function (params){
                                    var colorList = color_type;
                                    return colorList[params.dataIndex];
                                }
                            }
                        },
                        {
                            name: 'types2',
                            type: 'bar',
                            stack: '1',
                            //itemStyle: itemStyle,
                            data: [-type_list2[0].length, -type_list2[1].length, -type_list2[2].length,
                            -type_list2[3].length, -type_list2[4].length, -type_list2[5].length],
                        },
                ]
            };
            typeChart.on('click', function(param) {
                console.log(param.dataIndex);
                chosen_type[param.dataIndex] = !chosen_type[param.dataIndex];
                if (chosen_type[param.dataIndex])
                    color_type[param.dataIndex] = "#FE8463";
                else
                    color_type[param.dataIndex] = "#4ABACE";
                var allFalse = true;
                var result_list = []
                for (i in chosen_type) {
                    if (chosen_type[i] == true) {
                            for (j in type_list[i]) {
                                result_list.push(type_list[i][j]);
                            }
                        allFalse = false;
                    }
                }
                console.log(chosen_type);
                console.log(allFalse);
                if (allFalse) {
                    result_list = shotlist;
                }
                option_shotpoints.series[0].data = result_list;
                typeChart.setOption(option_type);
                shotpointsChat.setOption(option_shotpoints);
            });
            typeChart.setOption(option_type);

            
            // 投篮时间表
            var timeChart = echarts.init(document.getElementById('time'));
            var time_AxisData = [];
            var time_data = [];
            for (i = 0; i < 13; i++) {
                time_AxisData.push(i.toString() + ':00');
                time_AxisData.push(i.toString() + ':30');
                time_data.push([]);
                time_data.push([]);
            }
            for (i in shotlist) {
                var num = 0;
                if (parseInt(shotlist[i][3].split(':')[2]) >= 30)
                    num = 1;
                var e_index = 2*parseInt(shotlist[i][3].split(':')[1]) + num;
                time_data[e_index].push(shotlist[i]);
            }
            time_num_data = [];
            for (i in time_data) {
                time_num_data.push(time_data[i].length);
            }
            console.log(time_data);
            option_time = {
                title: {
                    text: 'Remaining Time'
                },
                // toolbox: {
                //     // y: 'bottom',
                //     feature: {
                //         magicType: { type: ['stack', 'tiled']},
                //         dataView: {},
                //         saveAsImage: { pixelRatio: 2}
                //     }
                // },
                tooltip: {},
                brush: {
                    //toolbox: ['rect', 'polygon', 'lineX', 'lineY', 'keep', 'clear'],
                    toolbox: ['lineX', 'clear'],
                    xAxisIndex: 0
                },
                xAxis: {
                    data: time_AxisData,
                    silent: false,
                    splitLine: {
                        show: false
                    }
                },
                yAxis: {},
                series: [{
                    name: 'bar',
                    type: 'bar',
                    data: time_num_data,
                    animationDelay: function (idx) {
                        return idx * 10;
                    }
                }],
                animationEasing: 'elasticOut',
                animationDelayUpdate: function (idx) {
                    return idx * 5;
                }
            };

            timeChart.on('brushSelected', function(param) {
                var brushed = [];
                var brushComponent = param.batch[0];
                var rawIndices = brushComponent.selected[0].dataIndex;
                var result_list = []
                for (i in rawIndices) {
                    for (j in time_data[rawIndices[i]]) {
                        result_list.push(time_data[rawIndices[i]][j]);
                    }
                }
                if (rawIndices.length == 0) {
                    result_list = shotlist;
                }
                option_shotpoints.series[0].data = result_list;
                shotpointsChat.setOption(option_shotpoints);

                var type_list2_num = [];
                for (i in type_list) {
                    var sum_num = 0;
                    for (j in type_list[i]) {
                        var num = 0;
                        if (parseInt(type_list[i][j][3].split(':')[2]) >= 30)
                            num = 1;
                        var e_index = 2*parseInt(type_list[i][j][3].split(':')[1]) + num;
                        if (e_index in rawIndices)
                            sum_num ++;
                    }
                    type_list2_num.push(-sum_num);
                }
                option_type.series[1].data = type_list2_num;
                typeChart.setOption(option_type);
            });
            timeChart.setOption(option_time);

        }, function(err) {
            console.log(err.message);
        });
        
    </script>

</head>

<body>

    <!-- START NAV -->
    <nav class="navbar is-white">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item brand-text" href="admin.html">NBA Analysis</a>
                <div class="navbar-burger burger" data-target="navMenu">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div id="navMenu" class="navbar-menu">
                <div class="navbar-start">
                    <a class="navbar-item" href="admin.html">Home</a>
                    <a class="navbar-item" href="admin.html">About Us</a>
                <div class="search bar6 navbar-item">
                    <form>
                        <input id="searchName" type="text" placeholder="请输入球星或球队名" name="cname">
                        <button id="searchBtn" type="submit" onclick="goToPlayer()"></button>
                    </form>
                </div>
                </div>

            </div>
        </div>
    </nav>
    <!-- END NAV -->
    <div class="container">
        <div class="player-summary_top">
            
            <div class="player-summary_image">
                <img id="playerPhoto" player-headshot="" player-id="1628391" team-id="1610612749" season="2018" class="player-img" src="https://ak-static.cms.nba.com/wp-content/uploads/headshots/nba/1610612749/2018/260x190/1628391.png" alt="D.J. Wilson" title="D.J. Wilson">
            </div>

            <div class="player-summary_info">
                <div class="player-summary__info-top">
                    <span ng-if="playerInfo.JERSEY" class="player-summary__player-number"><span class="player-summary__hash">#</span>5</span>
                    <div class="player-summary__player-name">
                        <p id = "name">D.J.</p>
                    </div>
                </div>
                <div class="player-summary_info-bottom">
                    <span class="player-summary_pos">F | </span>
                    <a ng-href="/team/1610612749/" href="/team/1610612749/"><span class="player-summary__team-name">Milwaukee Bucks</span></a>
                </div>
            </div>
        </div>

        <div class="player-summary_bottom">
            <div class="player-summary_col">
                <div class="player-summary_row">
                    <div class="player-state">HT</div>
                    <span class="player-value">10</span>
                </div>
                <div class="player-summary_row">
                    <div class="player-state">AGE</div>
                    <span class="player-value">22</span>
                </div>
            </div>

            <div class="player-summary_col">
                <div class="player-summary_row">
                    <div class="player-state">WT</div>
                    <span class="player-value">231</span>
                </div>
                <div class="player-summary_row">
                    <div class="player-state">BORN</div>
                    <span class="player-value">1997.12.17</span>
                </div>
            </div>
            
            <div class="player-summary_col">
                <div class="player-summary_row">
                    <div class="player-state">Prior</div>
                    <span class="player-value">Michigan</span>
                </div>
    
                <div class="player-summary_row">
                    <div class="player-state">Exp</div>
                    <span class="player-value">1yrs</span>
                </div>
            </div>
            
            <div class="player-summary_col2">
                <div class="player-state">PTS</div>
                <span class="player-value">1.0</span>
            </div>
            <div class="player-summary_col2">
                <div class="player-state">REB</div>
                <span class="player-value">1.0</span>
            </div>
            <div class="player-summary_col2">
                <div class="player-state">AST</div>
                <span class="player-value">1.0</span>
            </div>
            <div class="player-summary_col2">
                <div class="player-state">PIE</div>
                <span class="player-value">1.0</span>
            </div>
        </div>

        <style type="text/css">
            * {margin: 0; padding: 0;}
            #diagaram_container {height: 100%; width:100%; font-size: 0; margin: 1%; padding: 1%}
            #diagaram_container2 {height: 100%; width:100%; font-size: 0; margin: 1%; padding: 1%}
            #main, #type, #time, {display: inline-block; *display: inline; zoom: 1; vertical-align: top; font-size: 12px;}
            </style>
        <div id="diagaram_container" horizonal>
            <div style="float: left; width: 60%;"> 
                <div id="main" style="width: 100%; height:800px;"></div>
            </div>
            <div style="float: left; width: 40%;"> 
                <div id="type" style="width: 100%;height:400px;"></div>
                <div id="time" style="width: 100%;height:400px;"></div>
            </div>
        </div>
        
            
    </div>
</body>

</html>
